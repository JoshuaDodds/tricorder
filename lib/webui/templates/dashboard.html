<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page_title }}</title>
    <link rel="stylesheet" href="{{ static_url('css/dashboard.css') }}" />
    <script>
      window.TRICORDER_API_BASE = {{ api_base | default('', true) | tojson }};
    </script>
    <script type="module" src="{{ static_url('js/dashboard.js') }}" defer></script>
  </head>
  <body data-tricorder-api-base="{{ api_base | default('', true) }}">
    <div class="app-shell">
      <div
        id="system-banner"
        class="system-banner"
        role="alert"
        aria-live="assertive"
        hidden
        data-visible="false"
      >
        <div class="banner-icon" aria-hidden="true">!</div>
        <div class="banner-body">
          <h2 class="banner-title">SD card warning</h2>
          <p id="system-banner-message" class="banner-message">
            <span>
              Persistent SD card faults detected. Replace the card as soon as possible.
            </span>
            <a
              id="system-banner-help"
              class="banner-link"
              href="{{ static_url('docs/sd-card-recovery.html') }}"
              target="_blank"
              rel="noopener"
            >
              How to clone and replace the SD card
            </a>
          </p>
          <p id="system-banner-detail" class="banner-detail"></p>
        </div>
      </div>
      <header class="app-header">
        <div class="titles">
          <h1>Dashboard</h1>
          <button
            id="services-open"
            class="ghost-button"
            type="button"
            aria-haspopup="dialog"
            aria-expanded="false"
          >
            Services
          </button>
        </div>
        <div class="header-actions">
          <div class="header-status">
            <div
              id="recording-indicator"
              class="recording-indicator"
              role="status"
              aria-live="polite"
              aria-hidden="false"
              data-state="unknown"
            >
              <span class="indicator-dot" aria-hidden="true"></span>
              <span id="recording-indicator-text" class="indicator-text">Loading status…</span>
            </div>
            <div
              id="connection-status"
              class="connection-status"
              role="status"
              aria-live="polite"
              aria-hidden="true"
              data-visible="false"
            ></div>
          </div>
          <button id="refresh-button" class="ghost-button" type="button">Refresh</button>
          <div
            id="refresh-indicator"
            class="refresh-indicator"
            role="status"
            aria-live="polite"
            aria-hidden="true"
            data-visible="false"
          >
            <span class="refresh-spinner" aria-hidden="true"></span>
            <span class="refresh-text">Refreshing…</span>
          </div>
          <button id="live-stream-toggle" class="primary-button" type="button">Live Stream</button>
        </div>
      </header>
      <section class="status-bar">
        <div class="stat stat-recordings">
          <span class="label">Recordings</span>
          <span class="value" id="recording-count">0</span>
        </div>
        <div class="stat stat-selected">
          <span class="label">Selected</span>
          <span class="value" id="selected-count">0</span>
        </div>
        <div class="stat stat-selection-combined">
          <div class="stat-combined-row">
            <span class="label">Recordings</span>
            <span class="value" id="recording-count-mobile">0</span>
          </div>
          <div class="stat-combined-row">
            <span class="label">Selected</span>
            <span class="value" id="selected-count-mobile">0</span>
          </div>
        </div>
        <div class="stat storage-stat stat-storage">
          <span class="label">Storage</span>
          <span class="value" id="storage-usage-text">--</span>
          <div class="storage-progress">
            <div class="storage-progress-bar" id="storage-progress-bar"></div>
          </div>
          <span class="hint" id="storage-hint">--</span>
        </div>
        <div class="stat stat-last-updated">
          <span class="label">Last updated</span>
          <span class="value" id="last-updated">--</span>
        </div>
      </section>
      <section
        id="live-stream-card"
        class="card live-stream-card"
        hidden
        data-active="false"
        aria-hidden="true"
      >
        <div id="live-stream-panel" class="live-stream-panel" aria-hidden="true">
          <div class="live-stream-header">
            <div class="live-stream-titles">
              <h3>Live stream</h3>
              <span id="live-stream-status" class="live-stream-status">Idle</span>
            </div>
            <div class="live-stream-actions">
              <span class="live-stream-metric">Listeners <span id="live-stream-clients">0</span></span>
              <span class="live-stream-metric">Encoder <span id="live-stream-encoder">stopped</span></span>
              <button id="live-stream-close" class="ghost-button small" type="button">Hide</button>
            </div>
          </div>
          <audio id="live-stream-audio" controls preload="auto"></audio>
          <p class="live-stream-hint">Streaming pauses automatically when hidden.</p>
        </div>
      </section>
      <section class="main-grid">
        <div id="player-card" class="card player-card" hidden data-active="false">
          <div class="card-header">
            <div class="card-heading">
              <h2>Preview</h2>
              <div class="player-meta" id="player-meta">Select a recording to preview.</div>
            </div>
            <button id="preview-close" class="ghost-button small" type="button">Hide</button>
          </div>
          <audio id="preview-player" controls preload="none"></audio>
          <div class="waveform-section" id="waveform-section">
            <div class="waveform-header">
              <span>Waveform</span>
              <span class="waveform-status" id="waveform-status"></span>
            </div>
            <div class="waveform-container" id="waveform-container" hidden>
              <canvas id="waveform-canvas"></canvas>
              <div
                id="waveform-clock"
                class="waveform-clock"
                aria-hidden="true"
                data-active="false"
              >--:--:--</div>
              <div
                id="waveform-trigger-marker"
                class="waveform-marker marker-trigger"
                aria-hidden="true"
                data-active="false"
              >
                <span>Trigger</span>
              </div>
              <div
                id="waveform-release-marker"
                class="waveform-marker marker-release"
                aria-hidden="true"
                data-active="false"
              >
                <span>Release</span>
              </div>
              <div id="waveform-cursor" class="waveform-cursor" aria-hidden="true"></div>
            </div>
            <div class="waveform-empty" id="waveform-empty">Select a recording to render its waveform.</div>
          </div>
          <div
            id="clipper-container"
            class="clipper-container"
            data-enabled="false"
            data-available="false"
          >
            <div class="clipper-header">
              <div class="clipper-heading">
                <h3>Clip editor</h3>
                <span
                  id="clipper-status"
                  class="clipper-status"
                  aria-live="polite"
                  aria-hidden="true"
                ></span>
              </div>
              <button
                id="clipper-toggle"
                class="ghost-button small"
                type="button"
                aria-expanded="false"
                aria-pressed="false"
                aria-controls="clipper-section"
              >
                Enable clip editor
              </button>
            </div>
            <div
              id="clipper-summary"
              class="clipper-summary"
              role="status"
              aria-live="polite"
              aria-hidden="false"
            >
              Select a recording to use the clip editor.
            </div>
            <section
              id="clipper-section"
              class="clipper-section"
              hidden
              data-active="false"
              aria-hidden="true"
            >
              <form id="clipper-form" class="clipper-form" novalidate autocomplete="off">
                <div class="clipper-grid">
                  <label class="input-group clipper-group">
                    <span>Start</span>
                    <div class="clipper-input-row">
                      <input
                        id="clipper-start"
                        type="text"
                        inputmode="decimal"
                        placeholder="0:00.000"
                        autocomplete="off"
                      />
                      <button id="clipper-set-start" class="ghost-button small" type="button">
                        Set from playhead
                      </button>
                    </div>
                  </label>
                  <label class="input-group clipper-group">
                    <span>End</span>
                    <div class="clipper-input-row">
                      <input
                        id="clipper-end"
                        type="text"
                        inputmode="decimal"
                        placeholder="0:00.000"
                        autocomplete="off"
                      />
                      <button id="clipper-set-end" class="ghost-button small" type="button">
                        Set from playhead
                      </button>
                    </div>
                  </label>
                  <label class="input-group clipper-group clipper-name-group">
                    <span>Clip name</span>
                    <input
                      id="clipper-name"
                      type="text"
                      autocomplete="off"
                      placeholder="New clip name"
                    />
                  </label>
                </div>
                <div class="clipper-footer">
                  <div id="clipper-length" class="clipper-length" role="status" aria-live="polite">
                    --
                  </div>
                  <div class="clipper-buttons">
                    <button id="clipper-reset" class="ghost-button small" type="button">Reset</button>
                    <button id="clipper-submit" class="primary-button small" type="submit">Save clip</button>
                  </div>
                </div>
              </form>
            </section>
          </div>
        </div>
        <div class="card table-card">
            <div
              id="filters-panel"
              class="filters-panel"
              data-state="expanded"
              aria-hidden="false"
            >
              <div class="filters-header">
                <h3>Filters</h3>
                <div class="filters-actions">
                  <button
                    id="filters-close"
                    class="ghost-button small filters-close"
                    type="button"
                  >
                    Close
                  </button>
                  <button id="clear-filters" class="ghost-button small" type="button">Reset</button>
                  <button id="apply-filters" class="primary-button small" type="button">Apply</button>
                </div>
              </div>
              <div class="filters-grid">
                <label class="input-group">
                  <span>Search</span>
                  <input id="filter-search" type="search" placeholder="Name or path" autocomplete="off" />
                </label>
                <label class="input-group">
                  <span>Day</span>
                  <select id="filter-day">
                    <option value="">All days</option>
                  </select>
                </label>
                <label class="input-group">
                  <span>Limit</span>
                  <input id="filter-limit" type="number" min="1" max="1000" value="200" />
                </label>
              </div>
            </div>
            <div class="card-header">
              <div class="table-header-main">
                <h2>Recent recordings</h2>
                <button
                  id="filters-toggle"
                  class="ghost-button small filters-toggle"
                  type="button"
                  aria-expanded="true"
                  aria-controls="filters-panel"
                >
                  Filters
                </button>
              </div>
              <div class="table-actions">
                <button id="select-all" class="ghost-button small" type="button">Select all</button>
                <button id="clear-selection" class="ghost-button small" type="button">Clear</button>
                <button id="delete-selected" class="danger-button small" type="button" disabled>Delete selected</button>
              </div>
            </div>
            <div class="table-responsive">
              <table id="recordings-table">
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="toggle-all" aria-label="Toggle all" />
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="name">
                        Name
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="day">
                        Day
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="modified">
                        Updated
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="duration">
                        Length
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="size_bytes">
                        Size
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="extension">
                        Type
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th class="actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="results-summary" id="results-summary" aria-live="polite">Loading recordings…</div>
              <div class="pagination-controls" id="pagination-controls" hidden>
                <button id="page-prev" class="ghost-button small" type="button">Previous</button>
                <span id="pagination-status" class="pagination-status">Page 1 of 1</span>
                <button id="page-next" class="ghost-button small" type="button">Next</button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="card config-card">
        <div class="card-header">
          <h2>Configuration snapshot</h2>
          <div class="card-subtitle">Read-only view of merged configuration.</div>
        </div>
        <div id="config-viewer" class="code-block" role="region" aria-live="polite"></div>
      </section>
    </div>
    <div
      id="confirm-modal"
      class="confirm-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="confirm-modal-dialog"
        class="confirm-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-modal-title"
        aria-describedby="confirm-modal-message"
        tabindex="-1"
      >
        <h2 id="confirm-modal-title" class="confirm-title">Delete recordings</h2>
        <p id="confirm-modal-message" class="confirm-message"></p>
        <div class="confirm-actions">
          <button id="confirm-modal-confirm" class="danger-button" type="button">OK</button>
          <button id="confirm-modal-cancel" class="ghost-button" type="button">Cancel</button>
        </div>
      </div>
    </div>
    <div
      id="services-modal"
      class="services-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="services-dialog"
        class="services-dialog card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="services-dialog-title"
        aria-describedby="services-dialog-description"
        tabindex="-1"
      >
        <div class="card-header services-dialog-header">
          <div class="card-heading">
            <h2 id="services-dialog-title">Service controls</h2>
            <p id="services-dialog-description" class="card-subtitle">
              Start, stop, or reload systemd units. Web UI restarts automatically.
            </p>
          </div>
          <div class="services-dialog-actions">
            <button id="services-refresh" class="ghost-button small" type="button">Refresh</button>
            <button id="services-close" class="ghost-button small" type="button">Close</button>
          </div>
        </div>
        <div id="services-dialog-body" class="services-dialog-body">
          <div
            id="services-status"
            class="services-status"
            role="status"
            aria-live="polite"
            aria-hidden="true"
          ></div>
          <div
            id="services-list"
            class="services-list"
            role="region"
            aria-live="polite"
            aria-label="Service statuses"
          ></div>
          <div id="services-empty" class="services-empty" hidden>No managed services configured.</div>
        </div>
      </div>
    </div>
  </body>
</html>
