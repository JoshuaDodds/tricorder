<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{ page_title }}</title>
    <link rel="icon" href="{{ static_url('img/tricorder-logo.svg') }}" type="image/svg+xml" />
    <link rel="stylesheet" href="{{ static_url('css/dashboard.css') }}" />
    <script>
      window.TRICORDER_API_BASE = {{ api_base | default('', true) | tojson }};
    </script>
    <script type="module" src="{{ static_url('js/dashboard.js') }}" defer></script>
  </head>
  <body
    data-tricorder-api-base="{{ api_base | default('', true) }}"
    data-tricorder-stream-mode="{{ stream_mode | default('hls', true) }}"
    data-tricorder-webrtc-ice-servers='{{ webrtc_ice_servers | default([], true) | tojson }}'
  >
    <div class="app-shell">
      <div
        id="system-banner"
        class="system-banner"
        role="alert"
        aria-live="assertive"
        hidden
        data-visible="false"
      >
        <div class="banner-icon" aria-hidden="true">!</div>
        <div class="banner-body">
          <h2 class="banner-title">SD card warning</h2>
          <p id="system-banner-message" class="banner-message">
            <span>
              Persistent SD card faults detected. Replace the card as soon as possible.
            </span>
            <a
              id="system-banner-help"
              class="banner-link"
              href="{{ static_url('docs/sd-card-recovery.html') }}"
              target="_blank"
              rel="noopener"
            >
              How to clone and replace the SD card
            </a>
          </p>
          <p id="system-banner-detail" class="banner-detail"></p>
        </div>
      </div>
      <header class="app-header">
        <div class="titles">
          <div class="app-brand">
            <div class="app-menu-wrapper">
              <button
                id="app-menu-toggle"
                class="icon-button app-menu-toggle"
                type="button"
                aria-haspopup="true"
                aria-expanded="false"
                aria-controls="app-menu"
              >
                <span class="sr-only">Open menu</span>
                <span aria-hidden="true" class="menu-icon">
                  <span></span>
                  <span></span>
                  <span></span>
                </span>
              </button>
              <div
                id="app-menu"
                class="app-menu"
                role="menu"
                aria-hidden="true"
                aria-labelledby="app-menu-toggle"
                hidden
                data-visible="false"
              >
                <div class="menu-section" role="none">
                  <div class="menu-section-title" role="presentation">Recorder configuration</div>
                  <button
                    id="recorder-menu-audio"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="audio"
                  >
                    Audio input &amp; gain
                  </button>
                  <button
                    id="recorder-menu-segmenter"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="segmenter"
                  >
                    Event detection
                  </button>
                  <button
                    id="recorder-menu-adaptive"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="adaptive_rms"
                  >
                    Adaptive RMS
                  </button>
                  <button
                    id="recorder-menu-ingest"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="ingest"
                  >
                    Ingest pipeline
                  </button>
                  <button
                    id="recorder-menu-transcription"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="transcription"
                  >
                    Transcription
                  </button>
                  <button
                    id="recorder-menu-logging"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="logging"
                  >
                    Logging &amp; diagnostics
                  </button>
                  <button
                    id="recorder-menu-streaming"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="streaming"
                  >
                    Live streaming
                  </button>
                  <button
                    id="recorder-menu-dashboard"
                    class="menu-item recorder-menu-item"
                    type="button"
                    role="menuitem"
                    data-recorder-section="dashboard"
                  >
                    Dashboard API access
                  </button>
                </div>
                <div class="menu-section" role="none">
                  <div class="menu-section-title" role="presentation">Operations</div>
                  <button
                    id="config-open"
                    class="menu-item"
                    type="button"
                    role="menuitem"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    Configuration
                  </button>
                  <button
                    id="archival-open"
                    class="menu-item"
                    type="button"
                    role="menuitem"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    Archival settings
                  </button>
                  <button
                    id="web-server-open"
                    class="menu-item"
                    type="button"
                    role="menuitem"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    Web server
                  </button>
                  <button
                    id="services-open"
                    class="menu-item"
                    type="button"
                    role="menuitem"
                    aria-haspopup="dialog"
                    aria-expanded="false"
                  >
                    Services
                  </button>
                </div>
              </div>
            </div>
            <h1 class="app-title">
              <span class="sr-only">Tricorder dashboard home</span>
              <svg
                class="app-title-logo"
                viewBox="0 0 56 56"
                aria-hidden="true"
                focusable="false"
              >
                <defs>
                  <linearGradient
                    id="dashboard-logo-gradient"
                    x1="11"
                    y1="4"
                    x2="44"
                    y2="52"
                    gradientUnits="userSpaceOnUse"
                  >
                    <stop stop-color="#f97316" />
                    <stop offset="1" stop-color="#fbbf24" />
                  </linearGradient>
                </defs>
                <rect x="4" y="4" width="48" height="48" rx="14" fill="url(#dashboard-logo-gradient)" />
                <text
                  x="28"
                  y="38"
                  text-anchor="middle"
                  font-family="'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif"
                  font-size="30"
                  font-weight="700"
                  fill="#ffffff"
                >3</text>
              </svg>
              <span class="app-title-text">
                <span class="app-title-text-primary">Corder</span>
                <span class="app-title-text-secondary">DASHBOARD</span>
              </span>
            </h1>
          </div>
        </div>
        <div class="header-actions">
          <div class="header-controls">
            <button
              id="theme-toggle"
              class="ghost-button"
              type="button"
              aria-pressed="false"
              aria-label="Toggle light and dark theme"
            >
              Toggle theme
            </button>
            <button id="live-stream-toggle" class="primary-button" type="button">Live Stream</button>
          </div>
          <div class="header-status-group">
            <div class="status-labels">
              <div
                id="recording-indicator"
                class="status-pill recording-indicator"
                role="status"
                aria-live="polite"
                aria-hidden="false"
                data-state="unknown"
              >
                <span class="indicator-dot" aria-hidden="true"></span>
                <span
                  id="rms-indicator"
                  class="rms-indicator"
                  aria-hidden="true"
                  data-visible="false"
                >
                  <span class="label">RMS</span>
                  <span id="rms-indicator-value" class="value">0</span>
                </span>
                <span id="recording-indicator-text" class="indicator-text">Loading status…</span>
              </div>
              <div
                id="recording-meta"
                class="status-pill"
                role="status"
                aria-live="polite"
                aria-hidden="true"
                data-visible="false"
              >
                <span id="recording-meta-text" class="indicator-text"></span>
              </div>
              <div
                id="encoding-status"
                class="status-pill"
                role="status"
                aria-live="polite"
                aria-hidden="true"
                data-visible="false"
              >
                <span id="encoding-status-text" class="indicator-text"></span>
              </div>
            </div>
            <div
              id="connection-status"
              class="connection-status"
              role="status"
              aria-live="polite"
              aria-hidden="true"
              data-visible="false"
            ></div>
          </div>
        </div>
      </header>
      <section class="status-bar">
        <div class="stat stat-counts">
          <div class="stat-count-row">
            <span class="label">Recordings</span>
            <span class="value" id="recording-count">0</span>
          </div>
          <div class="stat-count-row">
            <span class="label">Selected</span>
            <span class="value" id="selected-count">0</span>
          </div>
        </div>
        <div class="stat stat-resource stat-cpu">
          <span class="label">CPU</span>
          <div class="stat-resource-values">
            <span class="value" id="cpu-usage-value">--</span>
            <span class="stat-resource-detail" id="cpu-load-average">--</span>
          </div>
        </div>
        <div class="stat stat-resource stat-memory">
          <span class="label">Memory</span>
          <div class="stat-resource-values">
            <span class="value" id="memory-usage-value">--</span>
            <span class="stat-resource-detail" id="memory-usage-detail">--</span>
          </div>
        </div>
        <div class="stat storage-stat stat-storage">
          <span class="label">Storage use</span>
          <span class="value" id="storage-usage-text">--</span>
          <div class="storage-progress">
            <div class="storage-progress-bar" id="storage-progress-bar"></div>
          </div>
          <span class="hint" id="storage-hint">--</span>
        </div>
        <div class="stat stat-last-updated">
          <span class="label">Last updated</span>
          <span class="value" id="last-updated">--</span>
        </div>
      </section>
      <section
        id="live-stream-card"
        class="card live-stream-card"
        hidden
        data-active="false"
        aria-hidden="true"
      >
        <div id="live-stream-panel" class="live-stream-panel" aria-hidden="true">
          <div class="live-stream-header">
            <div class="live-stream-titles">
              <h3>Live stream</h3>
              <span id="live-stream-status" class="live-stream-status">Idle</span>
            </div>
            <div class="live-stream-actions">
              <span class="live-stream-metric">Listeners <span id="live-stream-clients">0</span></span>
              <span class="live-stream-metric">Encoder <span id="live-stream-encoder">stopped</span></span>
              <button id="live-stream-close" class="ghost-button small" type="button">Hide</button>
            </div>
          </div>
          <audio id="live-stream-audio" controls preload="auto"></audio>
          <p class="live-stream-hint">Streaming pauses automatically when hidden.</p>
        </div>
      </section>
      <section class="main-grid">
        <div id="player-card" class="card player-card" hidden data-active="false" data-context="recordings">
          <div class="card-header">
            <div class="card-heading">
              <h2>Preview</h2>
            </div>
            <button id="preview-close" class="ghost-button small" type="button">Hide</button>
          </div>
          <audio id="preview-player" controls preload="none"></audio>
          <div class="waveform-section" id="waveform-section">
            <div class="waveform-header">
              <span>Waveform</span>
              <span class="waveform-status" id="waveform-status"></span>
            </div>
            <div class="waveform-clock-row" data-active="false">
              <div
                id="waveform-clock"
                class="waveform-clock"
                aria-hidden="true"
                data-active="false"
              >--:--:--</div>
            </div>
            <div class="waveform-container" id="waveform-container" hidden>
              <canvas id="waveform-canvas"></canvas>
              <div
                id="waveform-trigger-marker"
                class="waveform-marker marker-trigger"
                aria-hidden="true"
                data-active="false"
              >
                <span>Trigger</span>
              </div>
              <div
                id="waveform-release-marker"
                class="waveform-marker marker-release"
                aria-hidden="true"
                data-active="false"
              >
                <span>Release</span>
              </div>
              <div id="waveform-cursor" class="waveform-cursor" aria-hidden="true"></div>
            </div>
            <div class="waveform-rms-row" id="waveform-rms-row" data-active="false">
              <div
                id="waveform-rms-value"
                class="waveform-rms"
                aria-hidden="true"
                data-active="false"
              >
                RMS --
              </div>
            </div>
            <div class="waveform-empty" id="waveform-empty">Select a recording to render its waveform.</div>
          </div>
          <div class="player-meta" id="player-meta">
            <div class="player-meta-text" id="player-meta-text">Select a recording to preview.</div>
            <div class="player-meta-actions action-buttons" id="player-meta-actions" hidden>
              <a id="player-download" class="ghost-button small" download>Download</a>
              <button id="player-rename" class="ghost-button small" type="button">Rename</button>
              <button id="player-delete" class="danger-button small" type="button">Delete</button>
            </div>
          </div>
          <div
            id="clipper-container"
            class="clipper-container"
            data-enabled="false"
            data-available="false"
          >
            <div class="clipper-header">
              <div class="clipper-heading">
                <h3>Clip editor</h3>
                <span
                  id="clipper-status"
                  class="clipper-status"
                  aria-live="polite"
                  aria-hidden="true"
                ></span>
              </div>
              <button
                id="clipper-toggle"
                class="ghost-button small"
                type="button"
                aria-expanded="false"
                aria-pressed="false"
                aria-controls="clipper-section"
              >
                Enable clip editor
              </button>
            </div>
            <div
              id="clipper-summary"
              class="clipper-summary"
              role="status"
              aria-live="polite"
              aria-hidden="false"
            >
              Select a recording to use the clip editor.
            </div>
            <section
              id="clipper-section"
              class="clipper-section"
              hidden
              data-active="false"
              aria-hidden="true"
            >
              <form id="clipper-form" class="clipper-form" novalidate autocomplete="off">
                <div class="clipper-grid">
                  <label class="input-group clipper-group">
                    <span>Start</span>
                    <div class="clipper-input-row">
                      <input
                        id="clipper-start"
                        type="text"
                        inputmode="decimal"
                        placeholder="0:00.000"
                        autocomplete="off"
                      />
                      <button id="clipper-set-start" class="ghost-button small" type="button">
                        Set from playhead
                      </button>
                    </div>
                  </label>
                  <label class="input-group clipper-group">
                    <span>End</span>
                    <div class="clipper-input-row">
                      <input
                        id="clipper-end"
                        type="text"
                        inputmode="decimal"
                        placeholder="0:00.000"
                        autocomplete="off"
                      />
                      <button id="clipper-set-end" class="ghost-button small" type="button">
                        Set from playhead
                      </button>
                    </div>
                  </label>
                  <label class="input-group clipper-group clipper-name-group">
                    <span>Clip name</span>
                    <input
                      id="clipper-name"
                      type="text"
                      autocomplete="off"
                      placeholder="New clip name"
                    />
                  </label>
                  <div class="clipper-overwrite-row">
                    <label class="clipper-overwrite-toggle" for="clipper-overwrite-toggle">
                      <input id="clipper-overwrite-toggle" type="checkbox" checked />
                      <span class="clipper-overwrite-slider" aria-hidden="true"></span>
                      <span class="clipper-overwrite-label">Overwrite existing?</span>
                    </label>
                  </div>
                </div>
                <div class="clipper-footer">
                  <div id="clipper-length" class="clipper-length" role="status" aria-live="polite">
                    --
                  </div>
                  <div class="clipper-buttons">
                    <button id="clipper-undo" class="ghost-button small" type="button" hidden>Undo</button>
                    <button id="clipper-reset" class="ghost-button small" type="button">Reset</button>
                    <button id="clipper-submit" class="primary-button small" type="submit">Save clip</button>
                  </div>
                </div>
              </form>
            </section>
          </div>
        </div>
        <div class="card table-card">
            <div
              id="filters-panel"
              class="filters-panel"
              data-state="expanded"
              aria-hidden="false"
            >
              <div class="filters-header">
                <h3>Filters</h3>
                <div class="filters-actions">
                  <button
                    id="filters-close"
                    class="ghost-button small filters-close"
                    type="button"
                  >
                    Close
                  </button>
                  <button id="clear-filters" class="ghost-button small" type="button">Reset</button>
                  <button id="apply-filters" class="primary-button small" type="button">Apply</button>
                </div>
              </div>
              <div class="filters-grid">
                <label class="input-group">
                  <span>Search</span>
                  <input id="filter-search" type="search" placeholder="Name or path" autocomplete="off" />
                </label>
                <label class="input-group">
                  <span>Day</span>
                  <select id="filter-day">
                    <option value="">All days</option>
                  </select>
                </label>
                <label class="input-group">
                  <span>Time range <small>(h = hour, d = day)</small></span>
                  <select id="filter-time-range">
                    <option value="">All time</option>
                    <option value="1h">Past 1 hour (1h)</option>
                    <option value="2h">Past 2 hours (2h)</option>
                    <option value="4h">Past 4 hours (4h)</option>
                    <option value="8h">Past 8 hours (8h)</option>
                    <option value="12h">Past 12 hours (12h)</option>
                    <option value="1d">Past 1 day (1d)</option>
                  </select>
                </label>
                <label class="input-group">
                  <span>Limit</span>
                  <input id="filter-limit" type="number" min="1" max="1000" value="200" />
                </label>
              </div>
            </div>
            <div class="card-header">
              <div class="table-header-main">
                <h2>Recent recordings</h2>
                <button
                  id="filters-toggle"
                  class="ghost-button small filters-toggle"
                  type="button"
                  aria-expanded="true"
                  aria-controls="filters-panel"
                >
                  Filters
                </button>
              </div>
              <div class="table-actions">
                <button id="select-all" class="ghost-button small" type="button">Select all</button>
                <button id="clear-selection" class="ghost-button small" type="button">Clear</button>
                <button id="download-selected" class="ghost-button small" type="button" disabled>
                  Download selected
                </button>
                <button id="rename-selected" class="ghost-button small" type="button" disabled>
                  Rename selected
                </button>
                <button id="open-recycle-bin" class="ghost-button small" type="button">Recycle bin</button>
                <button id="delete-selected" class="danger-button small" type="button" disabled>
                  Move to recycle bin
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table id="recordings-table">
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input type="checkbox" id="toggle-all" aria-label="Toggle all" />
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="name">
                        Name
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="day">
                        Day
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="modified">
                        Updated
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="duration">
                        Length
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="size_bytes">
                        Size
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th>
                      <button type="button" class="sort-button" data-sort-key="extension">
                        Type
                        <span aria-hidden="true" class="sort-indicator"></span>
                      </button>
                    </th>
                    <th class="actions">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="table-footer">
              <div class="results-summary" id="results-summary" aria-live="polite">Loading recordings…</div>
              <div class="pagination-controls" id="pagination-controls" hidden>
                <button id="page-prev" class="ghost-button small" type="button">Previous</button>
                <span id="pagination-status" class="pagination-status">Page 1 of 1</span>
                <button id="page-next" class="ghost-button small" type="button">Next</button>
              </div>
            </div>
          </div>
        </div>
      </section>
    </div>
    <div
      id="confirm-modal"
      class="confirm-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="confirm-modal-dialog"
        class="confirm-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="confirm-modal-title"
        aria-describedby="confirm-modal-message"
        tabindex="-1"
      >
        <h2 id="confirm-modal-title" class="confirm-title">Move recordings to recycle bin</h2>
        <p id="confirm-modal-message" class="confirm-message"></p>
        <div class="confirm-actions">
          <button id="confirm-modal-confirm" class="danger-button" type="button">Move</button>
          <button id="confirm-modal-cancel" class="ghost-button" type="button">Cancel</button>
        </div>
      </div>
    </div>
    <div
      id="rename-modal"
      class="rename-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="rename-modal-dialog"
        class="rename-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="rename-modal-title"
        tabindex="-1"
      >
        <h2 id="rename-modal-title" class="rename-title">Rename recording</h2>
        <form id="rename-form" class="rename-form">
          <label class="input-group">
            <span>New name</span>
            <input id="rename-input" type="text" autocomplete="off" required spellcheck="false" />
          </label>
          <p id="rename-error" class="rename-error" role="alert" hidden></p>
          <div class="rename-actions">
            <button id="rename-cancel" class="ghost-button" type="button">Cancel</button>
            <button id="rename-confirm" class="primary-button" type="submit">Rename</button>
          </div>
        </form>
      </div>
    </div>
    <div
      id="recycle-bin-modal"
      class="recycle-bin-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="recycle-bin-dialog"
        class="recycle-bin-dialog card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="recycle-bin-title"
        aria-describedby="recycle-bin-description"
        tabindex="-1"
      >
        <div class="card-header recycle-bin-header">
          <div class="card-heading">
            <h2 id="recycle-bin-title">Recycle bin</h2>
            <p id="recycle-bin-description" class="card-subtitle">
              Recently removed recordings are staged here until you restore them.
            </p>
          </div>
          <div class="stat stat-counts recycle-bin-counts" role="status" aria-live="polite">
            <div class="stat-count-row">
              <span class="label">Recordings</span>
              <span class="value" id="recycle-bin-total-count">0</span>
            </div>
            <div class="stat-count-row">
              <span class="label">Selected</span>
              <span class="value" id="recycle-bin-selected-count">0</span>
            </div>
          </div>
          <div class="recycle-bin-header-actions">
            <button id="recycle-bin-refresh" class="ghost-button small" type="button">Refresh</button>
            <button id="recycle-bin-restore" class="primary-button small" type="button" disabled>
              Restore selected
            </button>
            <button id="recycle-bin-purge" class="danger-button small" type="button" disabled>
              Delete permanently
            </button>
            <button id="recycle-bin-close" class="ghost-button small" type="button">Close</button>
          </div>
        </div>
        <div class="recycle-bin-body">
          <div class="recycle-bin-list" role="region" aria-live="polite">
            <div class="table-responsive recycle-bin-table-wrapper">
              <table id="recycle-bin-table" class="recycle-bin-table">
                <thead>
                  <tr>
                    <th class="checkbox-cell">
                      <input
                        type="checkbox"
                        id="recycle-bin-toggle-all"
                        aria-label="Select all recycled recordings"
                      />
                    </th>
                    <th>Name</th>
                    <th>Original path</th>
                    <th>Deleted</th>
                    <th>Size</th>
                  </tr>
                </thead>
                <tbody id="recycle-bin-tbody"></tbody>
              </table>
            </div>
            <div id="recycle-bin-empty" class="recycle-bin-empty" hidden>
              No recordings in the recycle bin.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div
      id="services-modal"
      class="services-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="services-dialog"
        class="services-dialog card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="services-dialog-title"
        aria-describedby="services-dialog-description"
        tabindex="-1"
      >
        <div class="card-header services-dialog-header">
          <div class="card-heading">
            <h2 id="services-dialog-title">Service controls</h2>
            <p id="services-dialog-description" class="card-subtitle">
              Start, stop, or reload systemd units. Web UI restarts automatically.
            </p>
          </div>
          <div class="services-dialog-actions">
            <button id="services-refresh" class="ghost-button small" type="button">Refresh</button>
            <button id="services-close" class="ghost-button small" type="button">Close</button>
          </div>
        </div>
        <div id="services-dialog-body" class="services-dialog-body">
          <div
            id="services-status"
            class="services-status"
            role="status"
            aria-live="polite"
            aria-hidden="true"
          ></div>
          <div
            id="services-list"
            class="services-list"
            role="region"
            aria-live="polite"
            aria-label="Service statuses"
          ></div>
          <div id="services-empty" class="services-empty" hidden>No managed services configured.</div>
        </div>
      </div>
    </div>
    <div
      id="config-modal"
      class="settings-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="config-dialog"
        class="settings-dialog card config-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="config-dialog-title"
        aria-describedby="config-dialog-description"
        tabindex="-1"
      >
        <div class="card-header settings-dialog-header">
          <div class="card-heading">
            <h2 id="config-dialog-title">Configuration snapshot</h2>
            <p id="config-dialog-description" class="card-subtitle">
              Read-only view of merged configuration.
            </p>
          </div>
          <div class="settings-dialog-actions">
            <button id="config-close" class="ghost-button small" type="button">
              Close
            </button>
          </div>
        </div>
        <div class="settings-dialog-body config-dialog-body">
          <div class="settings-footnote">
            Loaded from <code id="config-dialog-path"></code>
          </div>
          <div id="config-viewer" class="code-block" role="region" aria-live="polite"></div>
        </div>
      </div>
    </div>
    <div
      id="recorder-settings-modal"
      class="settings-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="recorder-settings-dialog"
        class="settings-dialog card recorder-settings-dialog"
        role="dialog"
        aria-modal="true"
        aria-labelledby="recorder-settings-title"
        aria-describedby="recorder-settings-description"
        tabindex="-1"
        data-active-section=""
      >
        <div class="card-header settings-dialog-header">
          <div class="card-heading">
            <h2 id="recorder-settings-title">Recorder configuration</h2>
            <p id="recorder-settings-description" class="card-subtitle">
              Tune audio capture, event detection, ingest, and streaming settings without leaving the dashboard.
            </p>
          </div>
          <div class="settings-dialog-actions">
            <button id="recorder-settings-close" class="ghost-button small" type="button">
              Close
            </button>
          </div>
        </div>
        <div class="settings-dialog-body recorder-settings-body">
          <div class="settings-footnote">
            Saved to <code id="recorder-settings-config-path"></code>
          </div>

          <section
            class="settings-section recorder-section"
            data-section-key="audio"
            aria-labelledby="recorder-audio-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-audio-title" class="settings-section-title">Audio input &amp; gain</h3>
              <p class="settings-section-description">
                Select the ALSA capture device and frame characteristics used by the recorder pipeline.
              </p>
            </div>
            <form id="audio-form" class="settings-subform" novalidate>
              <div class="settings-field">
                <label for="audio-device">ALSA device</label>
                <input id="audio-device" type="text" autocomplete="off" />
                <p class="field-description">
                  Matches the identifier reported by <code>arecord -l</code>, for example
                  <code>hw:CARD=Device,DEV=0</code>.
                </p>
              </div>
              <div class="settings-field">
                <label for="audio-sample-rate">Sample rate</label>
                <select id="audio-sample-rate">
                  <option value="48000">48&nbsp;kHz (recommended)</option>
                  <option value="32000">32&nbsp;kHz</option>
                  <option value="16000">16&nbsp;kHz</option>
                </select>
                <p class="field-description">
                  Higher rates improve VAD accuracy and WebRTC stream quality at the cost of CPU and storage.
                </p>
              </div>
              <div class="settings-field">
                <label for="audio-frame-ms">Frame duration</label>
                <select id="audio-frame-ms">
                  <option value="10">10&nbsp;ms</option>
                  <option value="20">20&nbsp;ms</option>
                  <option value="30">30&nbsp;ms</option>
                </select>
                <p class="field-description">
                  Shorter frames reduce latency; 20&nbsp;ms balances responsiveness and CPU load.
                </p>
              </div>
              <div class="settings-field">
                <label for="audio-gain">Software gain</label>
                <input id="audio-gain" type="number" min="0.1" max="16" step="0.1" />
                <p class="field-description">
                  Linear multiplier applied before detection. Values above 4 can cause clipping on loud inputs.
                </p>
              </div>
              <div class="settings-field">
                <label for="audio-vad">VAD aggressiveness</label>
                <select id="audio-vad">
                  <option value="0">0 – permissive (captures most sounds)</option>
                  <option value="1">1 – low</option>
                  <option value="2">2 – balanced</option>
                  <option value="3">3 – strict (filters background noise)</option>
                </select>
                <p class="field-description">
                  Controls the WebRTC voice detector sensitivity. Higher values reject more noise but may miss quiet speech.
                </p>
              </div>
              <h4 class="settings-subheading">Filter chain</h4>
              <p class="settings-subheading-description">
                Enable lightweight filters to tame rumble, hiss, or bed noise before the segmenter sees the audio. Start with the
                high-pass filter, then layer in narrow notches for hums, and finally add noise gating once the noise floor is steady.
              </p>
              <div class="settings-field filter-field">
                <div class="filter-toggle field-control">
                  <input id="audio-filter-highpass-enabled" type="checkbox" />
                  <label for="audio-filter-highpass-enabled">High-pass filter</label>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-highpass-cutoff">Cutoff</label>
                  <input
                    id="audio-filter-highpass-cutoff"
                    type="range"
                    min="20"
                    max="2000"
                    step="10"
                    value="90"
                  />
                  <span id="audio-filter-highpass-cutoff-value" class="filter-value" aria-live="off">90&nbsp;Hz</span>
                </div>
                <p class="field-description">
                  Roll off sub-bass rumble from HVAC, footsteps, or desk bumps. Sweep between 80–120&nbsp;Hz; stop just before the
                  voices you care about start to thin out.
                </p>
              </div>
              <div class="settings-field filter-field">
                <div class="filter-toggle field-control">
                  <input id="audio-filter-notch-enabled" type="checkbox" />
                  <label for="audio-filter-notch-enabled">Notch filter</label>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-notch-frequency">Frequency</label>
                  <input
                    id="audio-filter-notch-frequency"
                    type="range"
                    min="20"
                    max="20000"
                    step="10"
                    value="60"
                  />
                  <span id="audio-filter-notch-frequency-value" class="filter-value" aria-live="off">60&nbsp;Hz</span>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-notch-quality">Quality</label>
                  <input
                    id="audio-filter-notch-quality"
                    type="range"
                    min="1"
                    max="80"
                    step="1"
                    value="30"
                  />
                  <span id="audio-filter-notch-quality-value" class="filter-value" aria-live="off">Q&nbsp;30</span>
                </div>
                <p class="field-description">
                  Carve out persistent hums (50/60&nbsp;Hz) or whistles without touching everything else. Aim the frequency at the
                  offending tone and keep Q in the 20–40 range for precise cuts.
                </p>
              </div>
              <div class="settings-field filter-field">
                <div class="filter-toggle field-control">
                  <input id="audio-filter-spectral-enabled" type="checkbox" />
                  <label for="audio-filter-spectral-enabled">Spectral noise gate</label>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-spectral-sensitivity">Sensitivity</label>
                  <input
                    id="audio-filter-spectral-sensitivity"
                    type="range"
                    min="0.1"
                    max="4"
                    step="0.1"
                    value="1.5"
                  />
                  <span id="audio-filter-spectral-sensitivity-value" class="filter-value" aria-live="off">1.5</span>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-spectral-reduction">Reduction</label>
                  <input
                    id="audio-filter-spectral-reduction"
                    type="range"
                    min="-60"
                    max="0"
                    step="1"
                    value="-18"
                  />
                  <span id="audio-filter-spectral-reduction-value" class="filter-value" aria-live="off">−18&nbsp;dB</span>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-spectral-update">Noise update rate</label>
                  <input
                    id="audio-filter-spectral-update"
                    type="range"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0.1"
                  />
                  <span id="audio-filter-spectral-update-value" class="filter-value" aria-live="off">0.10</span>
                </div>
                <div class="filter-slider">
                  <label class="filter-slider-label" for="audio-filter-spectral-decay">Noise decay</label>
                  <input
                    id="audio-filter-spectral-decay"
                    type="range"
                    min="0"
                    max="1"
                    step="0.01"
                    value="0.95"
                  />
                  <span id="audio-filter-spectral-decay-value" class="filter-value" aria-live="off">0.95</span>
                </div>
                <p class="field-description">
                  Adaptive noise gate for steady ambient beds. Use 1.2–1.8 sensitivity for HVAC rumble, pull reduction into the
                  −12 to −24&nbsp;dB window, then fine-tune update/decay to trade chatter for smooth releases.
                </p>
              </div>
              <h4 class="settings-subheading">Calibration helpers</h4>
              <p class="settings-subheading-description">
                Surface quick actions in the dashboard for recalibrating ambient noise and input gain with the room tuner.
              </p>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="audio-calibration-noise" type="checkbox" />
                  <label for="audio-calibration-noise">Allow noise profile calibration shortcut</label>
                </div>
                <p class="field-description">Adds a dashboard action to capture a fresh background noise profile.</p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="audio-calibration-gain" type="checkbox" />
                  <label for="audio-calibration-gain">Allow gain recalibration shortcut</label>
                </div>
                <p class="field-description">Exposes a guided gain recalibration using the room tuner utility.</p>
              </div>
              <div class="settings-field calibration-action">
                <button id="audio-calibrate-noise" class="ghost-button" type="button">
                  Calibrate noise profile
                </button>
                <p class="field-description">Launches the room tuner in a new tab to capture the current ambient noise floor.</p>
                <p
                  id="audio-calibration-noise-hint"
                  class="field-description"
                  hidden
                  aria-hidden="true"
                >
                  Enable “Allow noise profile calibration shortcut” above to use this action.
                </p>
              </div>
              <div class="settings-section-footer">
                <div id="audio-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="audio-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="audio-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="segmenter"
            aria-labelledby="recorder-segmenter-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-segmenter-title" class="settings-section-title">Event detection</h3>
              <p class="settings-section-description">
                Adjust trigger windows, thresholds, and buffer sizes used while segmenting audio into recordings.
              </p>
            </div>
            <form id="segmenter-form" class="settings-subform" novalidate>
              <div class="settings-field">
                <label for="segmenter-pre-pad">Pre-roll (ms)</label>
                <input id="segmenter-pre-pad" type="number" min="0" step="100" />
                <p class="field-description">Amount of context preserved before the trigger fires.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-post-pad">Post-roll (ms)</label>
                <input id="segmenter-post-pad" type="number" min="0" step="100" />
                <p class="field-description">How long to continue recording after activity stops.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-threshold">RMS threshold</label>
                <input id="segmenter-threshold" type="number" min="0" step="10" />
                <p class="field-description">Linear RMS trigger level after gain. Dial in with <code>room_tuner.py</code>.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-keep-window">Keep window (frames)</label>
                <input id="segmenter-keep-window" type="number" min="1" step="1" />
                <p class="field-description">Sliding window size used to refresh the post-roll timer.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-start-consecutive">Start frames required</label>
                <input id="segmenter-start-consecutive" type="number" min="1" step="1" />
                <p class="field-description">Consecutive active frames required before starting a recording.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-keep-consecutive">Keep frames required</label>
                <input id="segmenter-keep-consecutive" type="number" min="1" step="1" />
                <p class="field-description">Active frames needed within the window to continue an in-progress recording.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-flush-bytes">Flush threshold (bytes)</label>
                <input id="segmenter-flush-bytes" type="number" min="4096" step="1024" />
                <p class="field-description">Controls how often buffered WAV data is flushed to disk.</p>
              </div>
              <div class="settings-field">
                <label for="segmenter-max-queue">Max queued frames</label>
                <input id="segmenter-max-queue" type="number" min="16" step="16" />
                <p class="field-description">Upper bound on pending audio frames before applying backpressure.</p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="segmenter-use-rnnoise" type="checkbox" />
                  <label for="segmenter-use-rnnoise">Enable RNNoise denoising</label>
                </div>
                <p class="field-description">High quality but CPU intensive. Best suited for more powerful Pis.</p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="segmenter-use-noisereduce" type="checkbox" />
                  <label for="segmenter-use-noisereduce">Enable spectral noise reduction</label>
                </div>
                <p class="field-description">Experimental filter that can reduce steady background noise.</p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="segmenter-denoise-before-vad" type="checkbox" />
                  <label for="segmenter-denoise-before-vad">Denoise before VAD</label>
                </div>
                <p class="field-description">Applies denoising prior to voice detection. Can reduce sensitivity.</p>
              </div>
              <div class="settings-section-footer">
                <div id="segmenter-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="segmenter-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="segmenter-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="adaptive_rms"
            aria-labelledby="recorder-adaptive-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-adaptive-title" class="settings-section-title">Adaptive RMS</h3>
              <p class="settings-section-description">
                Automatically adjusts the RMS trigger as the room quiets down or becomes noisier.
              </p>
            </div>
            <form id="adaptive-form" class="settings-subform" novalidate>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="adaptive-enabled" type="checkbox" />
                  <label for="adaptive-enabled">Enable adaptive thresholding</label>
                </div>
                <p class="field-description">Tracks background noise and scales the trigger dynamically.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-min-thresh">Minimum threshold</label>
                <input id="adaptive-min-thresh" type="number" min="0" max="1" step="0.001" />
                <p class="field-description">Floor for the normalized RMS threshold (0–1 scale).</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-max-rms">Hard RMS ceiling</label>
                <input
                  id="adaptive-max-rms"
                  type="number"
                  min="0"
                  max="32767"
                  step="1"
                  inputmode="numeric"
                  placeholder="(optional)"
                />
                <p class="field-description">Ceiling that prevents the adaptive gate from climbing indefinitely.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-margin">Noise margin</label>
                <input id="adaptive-margin" type="number" min="0.5" max="10" step="0.05" />
                <p class="field-description">Multiplier applied to the observed background noise floor.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-update-interval">Update interval (s)</label>
                <input id="adaptive-update-interval" type="number" min="0.5" max="120" step="0.5" />
                <p class="field-description">How frequently the threshold is recomputed.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-window">Window length (s)</label>
                <input id="adaptive-window" type="number" min="1" max="300" step="1" />
                <p class="field-description">Rolling sample window for background RMS estimation.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-hysteresis">Hysteresis tolerance</label>
                <input id="adaptive-hysteresis" type="number" min="0" max="1" step="0.01" />
                <p class="field-description">Minimum proportional change before adopting a new threshold.</p>
              </div>
              <div class="settings-field">
                <label for="adaptive-release">Release percentile</label>
                <input id="adaptive-release" type="number" min="0.05" max="1" step="0.01" />
                <p class="field-description">Percentile of the noise distribution used when relaxing the threshold.</p>
              </div>
              <div class="settings-section-footer">
                <div id="adaptive-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="adaptive-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="adaptive-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="ingest"
            aria-labelledby="recorder-ingest-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-ingest-title" class="settings-section-title">Ingest pipeline</h3>
              <p class="settings-section-description">
                Control how files dropped into the ingest directory are validated and accepted.
              </p>
            </div>
            <form id="ingest-form" class="settings-subform" novalidate>
              <div class="settings-field">
                <label for="ingest-stable-checks">Stable checks required</label>
                <input id="ingest-stable-checks" type="number" min="1" max="20" step="1" />
                <p class="field-description">Number of size checks before a file is considered ready.</p>
              </div>
              <div class="settings-field">
                <label for="ingest-stable-interval">Check interval (s)</label>
                <input id="ingest-stable-interval" type="number" min="0.1" max="30" step="0.1" />
                <p class="field-description">Delay between size checks while watching incoming files.</p>
              </div>
              <div class="settings-field">
                <label for="ingest-allowed-ext">Allowed extensions</label>
                <textarea id="ingest-allowed-ext" rows="3"></textarea>
                <p class="field-description">One extension per line (include the leading dot).</p>
              </div>
              <div class="settings-field">
                <label for="ingest-ignore-suffixes">Ignore suffixes</label>
                <textarea id="ingest-ignore-suffixes" rows="3"></textarea>
                <p class="field-description">File suffixes that indicate partial downloads or temporary files.</p>
              </div>
              <div class="settings-section-footer">
                <div id="ingest-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="ingest-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="ingest-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="transcription"
            aria-labelledby="recorder-transcription-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-transcription-title" class="settings-section-title">Transcription</h3>
              <p class="settings-section-description">
                Enable offline speech recognition and control how transcripts are generated.
              </p>
            </div>
            <form id="transcription-form" class="settings-subform" novalidate>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="transcription-enabled" type="checkbox" />
                  <label for="transcription-enabled">Enable transcription</label>
                </div>
                <p class="field-description">
                  Runs Vosk locally during encoding to produce <code>.transcript.json</code> sidecars.
                </p>
              </div>
              <div class="settings-field">
                <label for="transcription-engine">Engine</label>
                <select id="transcription-engine">
                  <option value="vosk">Vosk (offline)</option>
                </select>
                <p class="field-description">Tricorder currently supports the Vosk offline recognizer.</p>
              </div>
              <div class="settings-field">
                <label for="transcription-types">Event types to transcribe</label>
                <textarea id="transcription-types" rows="3"></textarea>
                <p class="field-description">
                  One event label per line (e.g. <code>Human</code> or <code>Both</code>). Only matching recordings are processed.
                </p>
              </div>
              <div class="settings-field">
                <label for="transcription-model-path">Vosk model path</label>
                <input id="transcription-model-path" type="text" autocomplete="off" />
                <p class="field-description">
                  Absolute path to the unpacked Vosk model directory (download separately).
                </p>
              </div>
              <div class="settings-field">
                <label for="transcription-target-sample-rate">Target sample rate (Hz)</label>
                <input
                  id="transcription-target-sample-rate"
                  type="number"
                  min="8000"
                  max="96000"
                  step="1000"
                />
                <p class="field-description">
                  Audio is resampled before recognition. 16000&nbsp;Hz matches the small English models.
                </p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="transcription-include-words" type="checkbox" />
                  <label for="transcription-include-words">Include word timings</label>
                </div>
                <p class="field-description">
                  Store per-word timestamps and confidence values alongside the transcript text.
                </p>
              </div>
              <div class="settings-field">
                <label for="transcription-max-alternatives">Alternative transcripts</label>
                <input id="transcription-max-alternatives" type="number" min="0" max="10" step="1" />
                <p class="field-description">
                  Request extra hypotheses when supported by the model (0 disables alternatives).
                </p>
              </div>
              <div class="settings-section-footer">
                <div
                  id="transcription-status"
                  class="form-status"
                  role="status"
                  aria-live="polite"
                  aria-hidden="true"
                ></div>
                <div class="button-row">
                  <button id="transcription-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="transcription-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="logging"
            aria-labelledby="recorder-logging-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-logging-title" class="settings-section-title">Logging &amp; diagnostics</h3>
              <p class="settings-section-description">
                Enable verbose logging for troubleshooting noisy environments or new deployments.
              </p>
            </div>
            <form id="logging-form" class="settings-subform" novalidate>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="logging-dev-mode" type="checkbox" />
                  <label for="logging-dev-mode">Enable developer debug logs</label>
                </div>
                <p class="field-description">Outputs per-second segmenter stats to the journal.</p>
              </div>
              <div class="settings-section-footer">
                <div id="logging-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="logging-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="logging-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="streaming"
            aria-labelledby="recorder-streaming-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-streaming-title" class="settings-section-title">Live streaming</h3>
              <p class="settings-section-description">
                Switch between HLS and WebRTC streaming modes and adjust the WebRTC frame buffer.
              </p>
            </div>
            <form id="streaming-form" class="settings-subform" novalidate>
              <div class="settings-field">
                <label for="streaming-mode">Streaming mode</label>
                <select id="streaming-mode">
                  <option value="hls">HLS (compatible, higher latency)</option>
                  <option value="webrtc">WebRTC (low latency)</option>
                </select>
                <p class="field-description">The dashboard automatically adjusts its player to match.</p>
              </div>
              <div class="settings-field">
                <label for="streaming-history">WebRTC history (s)</label>
                <input id="streaming-history" type="number" min="1" max="600" step="0.5" />
                <p class="field-description">Seconds of PCM buffered for WebRTC listeners. Increase to absorb brief stalls.</p>
              </div>
              <div class="settings-section-footer">
                <div id="streaming-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="streaming-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="streaming-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>

          <section
            class="settings-section recorder-section"
            data-section-key="dashboard"
            aria-labelledby="recorder-dashboard-title"
          >
            <div class="settings-section-header">
              <h3 id="recorder-dashboard-title" class="settings-section-title">Dashboard API access</h3>
              <p class="settings-section-description">
                Point static dashboard builds at a remote recorder by overriding the API base URL.
              </p>
            </div>
            <form id="dashboard-form" class="settings-subform" novalidate>
              <div class="settings-field">
                <label for="dashboard-api-base">API base URL</label>
                <input id="dashboard-api-base" type="text" autocomplete="off" />
                <p class="field-description">
                  When set, static dashboards use this origin for API and streaming requests (example: <code>https://recorder.local:8080</code>).
                </p>
              </div>
              <div class="settings-section-footer">
                <div id="dashboard-status" class="form-status" role="status" aria-live="polite" aria-hidden="true"></div>
                <div class="button-row">
                  <button id="dashboard-reset" class="ghost-button" type="button" disabled>Reset</button>
                  <button id="dashboard-save" class="primary-button" type="submit" disabled>Save changes</button>
                </div>
              </div>
            </form>
          </section>
          <footer class="settings-dialog-footer recorder-settings-footer">
            <div class="settings-footer-actions">
              <div
                id="recorder-save-all-status"
                class="form-status"
                role="status"
                aria-live="polite"
                aria-hidden="true"
              ></div>
              <div class="button-row">
                <button id="recorder-save-all" class="primary-button" type="button" disabled>Save all changes</button>
              </div>
            </div>
          </footer>
        </div>
      </div>
    </div>
    <div
      id="web-server-modal"
      class="settings-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="web-server-dialog"
        class="settings-dialog card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="web-server-dialog-title"
        aria-describedby="web-server-dialog-description"
        tabindex="-1"
      >
        <div class="card-header settings-dialog-header">
          <div class="card-heading">
            <h2 id="web-server-dialog-title">Web server</h2>
            <p id="web-server-dialog-description" class="card-subtitle">
              Configure the dashboard listener and TLS settings.
            </p>
          </div>
          <div class="settings-dialog-actions">
            <button id="web-server-close" class="ghost-button small" type="button">
              Close
            </button>
          </div>
        </div>
        <form id="web-server-form" class="settings-form">
          <div class="settings-dialog-body">
            <section class="settings-section">
              <div class="settings-section-header">
                <h3 class="settings-section-title">Listener</h3>
                <p class="settings-section-description">
                  Choose how the dashboard API binds to the network.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-mode">Mode</label>
                <select id="web-server-mode">
                  <option value="http">HTTP (no TLS)</option>
                  <option value="https">HTTPS (TLS)</option>
                </select>
                <p class="field-description">
                  Switch to HTTPS to serve the dashboard securely using TLS certificates.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-host">Bind address</label>
                <input id="web-server-host" type="text" autocomplete="off" />
                <p class="field-description">
                  Default <code>0.0.0.0</code> listens on all interfaces. Use 127.0.0.1 to restrict to localhost.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-port">Port</label>
                <input id="web-server-port" type="number" min="1" max="65535" />
                <p class="field-description">
                  Recommended values: 80 for HTTP or 443 for HTTPS so browsers connect without a custom port.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-tls-provider">TLS provider</label>
                <select id="web-server-tls-provider">
                  <option value="letsencrypt">Let's Encrypt (automatic)</option>
                  <option value="manual">Manual certificate</option>
                </select>
                <p class="field-description">
                  Automatic certificates require public DNS and access to the HTTP challenge port.
                </p>
              </div>
            </section>

            <section
              id="web-server-letsencrypt-section"
              class="settings-section"
              data-active="false"
              aria-hidden="true"
              hidden
            >
              <div class="settings-section-header">
                <h3 class="settings-section-title">Let's Encrypt</h3>
                <p class="settings-section-description">
                  Issue and renew certificates automatically using certbot.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-domains">Domains</label>
                <textarea
                  id="web-server-letsencrypt-domains"
                  rows="3"
                  placeholder="recorder.example.com"
                ></textarea>
                <p class="field-description">
                  One domain per line. Each name must resolve to this recorder for validation to succeed.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-email">Contact email (optional)</label>
                <input id="web-server-letsencrypt-email" type="email" autocomplete="off" />
                <p class="field-description">
                  Used for renewal notices from Let's Encrypt. Leave blank to register without an email.
                </p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="web-server-letsencrypt-staging" type="checkbox" />
                  <label for="web-server-letsencrypt-staging">Use Let's Encrypt staging</label>
                </div>
                <p class="field-description">
                  Enable while testing to avoid production rate limits. Staging certificates are not trusted by browsers.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-http-port">Challenge port</label>
                <input id="web-server-letsencrypt-http-port" type="number" min="1" max="65535" />
                <p class="field-description">
                  Port used for HTTP-01 validation (default 80). Ensure it is reachable from the public internet.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-cache-dir">Cache directory</label>
                <input id="web-server-letsencrypt-cache-dir" type="text" autocomplete="off" />
                <p class="field-description">
                  Directory where certbot stores account data and issued certificates. Update when using a custom storage path.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-certbot">Certbot command</label>
                <input id="web-server-letsencrypt-certbot" type="text" autocomplete="off" />
                <p class="field-description">
                  Override the certbot executable (default <code>certbot</code>) if it is installed in a non-standard location.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-letsencrypt-renew-before">Renew before (days)</label>
                <input id="web-server-letsencrypt-renew-before" type="number" min="1" max="90" />
                <p class="field-description">
                  How many days before expiration the recorder requests a renewal. Increase for short validation windows.
                </p>
              </div>
            </section>

            <section
              id="web-server-manual-section"
              class="settings-section"
              data-active="false"
              aria-hidden="true"
              hidden
            >
              <div class="settings-section-header">
                <h3 class="settings-section-title">Manual certificate</h3>
                <p class="settings-section-description">
                  Provide paths to existing PEM files that contain the certificate and private key.
                </p>
              </div>
              <div class="settings-field">
                <label for="web-server-cert">Certificate path</label>
                <input id="web-server-cert" type="text" autocomplete="off" />
              </div>
              <div class="settings-field">
                <label for="web-server-key">Private key path</label>
                <input id="web-server-key" type="text" autocomplete="off" />
              </div>
            </section>
          </div>
          <footer class="settings-dialog-footer">
            <div class="settings-footnote">
              Saved to <code id="web-server-config-path"></code>
            </div>
            <div class="settings-footer-actions">
              <div
                id="web-server-status"
                class="form-status"
                role="status"
                aria-live="polite"
                aria-hidden="true"
              ></div>
              <div class="button-row">
                <button id="web-server-reset" class="ghost-button" type="button" disabled>
                  Reset
                </button>
                <button id="web-server-save" class="primary-button" type="submit" disabled>
                  Save changes
                </button>
              </div>
            </div>
          </footer>
        </form>
      </div>
    </div>

    <div
      id="archival-modal"
      class="settings-modal"
      hidden
      data-visible="false"
      aria-hidden="true"
    >
      <div
        id="archival-dialog"
        class="settings-dialog card"
        role="dialog"
        aria-modal="true"
        aria-labelledby="archival-dialog-title"
        aria-describedby="archival-dialog-description"
        tabindex="-1"
      >
        <div class="card-header settings-dialog-header">
          <div class="card-heading">
            <h2 id="archival-dialog-title">Archival settings</h2>
            <p id="archival-dialog-description" class="card-subtitle">
              Configure archival upload destinations and options.
            </p>
          </div>
          <div class="settings-dialog-actions">
            <button id="archival-close" class="ghost-button small" type="button">
              Close
            </button>
          </div>
        </div>
        <form id="archival-form" class="settings-form">
          <div class="settings-dialog-body">
            <section class="settings-section">
              <div class="settings-section-header">
                <h3 class="settings-section-title">Archival workflow</h3>
                <p class="settings-section-description">
                  Mirror new recordings to long-term storage immediately after encoding.
                </p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="archival-enabled" type="checkbox" />
                  <label for="archival-enabled">Enable automatic uploads</label>
                </div>
                <p class="field-description">
                  When enabled, each freshly encoded recording is copied using the selected backend.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-backend">Transfer method</label>
                <select id="archival-backend">
                  <option value="network_share">Network share (local mount)</option>
                  <option value="rsync">Rsync over SSH</option>
                </select>
                <p class="field-description">
                  Choose how files are sent off the recorder for archival storage.
                </p>
              </div>
              <div class="settings-field checkbox-field">
                <div class="field-control">
                  <input id="archival-include-waveforms" type="checkbox" />
                  <label for="archival-include-waveforms">Include waveform previews</label>
                </div>
                <p class="field-description">
                  Upload waveform JSON sidecars along with audio files for richer previews.
                </p>
              </div>
            </section>

            <section
              id="archival-network-share-section"
              class="settings-section"
              data-active="false"
              aria-hidden="true"
              hidden
            >
              <div class="settings-section-header">
                <h3 class="settings-section-title">Network share</h3>
                <p class="settings-section-description">
                  Copy recordings into a mounted SMB/NFS directory on the local filesystem.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-network-share-target">Share root</label>
                <input id="archival-network-share-target" type="text" autocomplete="off" />
                <p class="field-description">
                  Point to the mounted directory. Per-day folders are created automatically.
                </p>
              </div>
            </section>

            <section
              id="archival-rsync-section"
              class="settings-section"
              data-active="false"
              aria-hidden="true"
              hidden
            >
              <div class="settings-section-header">
                <h3 class="settings-section-title">Rsync over SSH</h3>
                <p class="settings-section-description">
                  Stream recordings to a remote rsync destination immediately after encoding completes.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-rsync-destination">Destination</label>
                <input
                  id="archival-rsync-destination"
                  type="text"
                  autocomplete="off"
                  placeholder="user@example.com:/srv/tricorder/archive"
                />
                <p class="field-description">
                  Use standard rsync syntax (user@host:/path). Required when rsync uploads are enabled.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-rsync-identity">SSH identity (optional)</label>
                <input
                  id="archival-rsync-identity"
                  type="text"
                  autocomplete="off"
                  placeholder="/home/pi/.ssh/id_ed25519"
                />
                <p class="field-description">
                  Leave blank to use the default SSH agent or system keys on the recorder.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-rsync-options">Additional rsync options</label>
                <textarea
                  id="archival-rsync-options"
                  rows="3"
                  placeholder="-az"
                ></textarea>
                <p class="field-description">
                  One flag per line. Leave empty to use the default <code>-az</code> arguments.
                </p>
              </div>
              <div class="settings-field">
                <label for="archival-rsync-ssh-options">Extra SSH options</label>
                <textarea
                  id="archival-rsync-ssh-options"
                  rows="3"
                  placeholder="-oStrictHostKeyChecking=yes"
                ></textarea>
                <p class="field-description">
                  Optional arguments appended to the rsync SSH command (one per line).
                </p>
              </div>
            </section>
          </div>
          <footer class="settings-dialog-footer">
            <div class="settings-footnote">
              Saved to <code id="archival-config-path"></code>
            </div>
            <div class="settings-footer-actions">
              <div
                id="archival-status"
                class="form-status"
                role="status"
                aria-live="polite"
                aria-hidden="true"
              ></div>
              <div class="button-row">
                <button id="archival-reset" class="ghost-button" type="button" disabled>Reset</button>
                <button id="archival-save" class="primary-button" type="submit" disabled>Save changes</button>
              </div>
            </div>
          </footer>
        </form>
      </div>
    </div>
    </div>
  </body>
</html>
